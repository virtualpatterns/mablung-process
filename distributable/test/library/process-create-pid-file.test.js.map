{"version":3,"sources":["../../../source/test/library/process-create-pid-file.test.js"],"names":["FileSystem","Is","Test","WorkerClient","LoggedClient","Process","ProcessArgumentError","Require","_createRequire","import","meta","url","before","test","context","basePath","ensureDir","serial","path","writeFile","process","pid","toString","throws","createPidFile","bind","unlink","true","pathExists","is","parseInt","readFile","deletePidFile","worker","resolve","module","exit","false","throwUncaughtException","Promise","setTimeout","windows","throwsAsync","Error","killPidFile"],"mappings":"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","sourcesContent":["import FileSystem from 'fs-extra'\nimport { Is } from '@virtualpatterns/mablung-is'\nimport Test from 'ava'\nimport { WorkerClient } from '@virtualpatterns/mablung-worker'\nimport { LoggedClient } from '@virtualpatterns/mablung-worker/logged-client.js'\n\nimport { Process, ProcessArgumentError } from '../../index.js'\n\nconst Require = __require\n\nTest.before(async (test) => {\n  test.context.basePath = 'process/pid/create-pid-file'\n  await FileSystem.ensureDir(test.context.basePath)\n})\n\nTest.serial('Process.createPidFile(path) when path exists and is valid', async (test) => {\n\n  let path = `${test.context.basePath}/exists-valid.pid`\n\n  await FileSystem.writeFile(path, process.pid.toString(), { 'encoding': 'utf-8' })\n\n  try {\n    test.throws(Process.createPidFile.bind(Process, path), { 'instanceOf': ProcessArgumentError })\n  } finally {\n    await FileSystem.unlink(path)\n  }\n\n})\n\nTest.serial('Process.createPidFile(path) when path does not exist', async (test) => {\n\n  let path = `${test.context.basePath}/not-exists.pid`\n\n  Process.createPidFile(path)\n\n  try {\n    test.true(await FileSystem.pathExists(path))\n    test.is(parseInt(await FileSystem.readFile(path, { 'encoding': 'utf-8' })), process.pid)\n  } finally {\n    Process.deletePidFile()\n  }\n\n})\n\nTest.serial('Process.createPidFile(path) when path exists and is invalid', async (test) => {\n\n  let path = `${test.context.basePath}/exists-invalid.pid`\n\n  await FileSystem.writeFile(path, '100000', { 'encoding': 'utf-8' })\n\n  Process.createPidFile(path)\n\n  try {\n    test.true(await FileSystem.pathExists(path))\n    test.is(parseInt(await FileSystem.readFile(path, { 'encoding': 'utf-8' })), process.pid)\n  } finally {\n    Process.deletePidFile()\n  }\n\n})\n\nTest.serial('Process.createPidFile(path) when called twice', (test) => {\n\n  let path = `${test.context.basePath}/twice.pid`\n\n  Process.createPidFile(path)\n\n  try {\n    test.throws(Process.createPidFile.bind(Process, path), { 'instanceOf': ProcessArgumentError })\n  } finally {\n    Process.deletePidFile()\n  }\n\n})\n\nTest.serial('Process.createPidFile(path) when using a worker', async (test) => {\n\n  let path = `${test.context.basePath}/worker.pid`\n  let worker = new WorkerClient(Require.resolve('./worker.js'))\n\n  try {\n\n    await worker.module.createPidFile(path)\n\n    try {\n      test.true(await FileSystem.pathExists(path))\n      test.is(parseInt(await FileSystem.readFile(path, { 'encoding': 'utf-8' })), worker.pid)\n    } finally {\n      await worker.module.deletePidFile()\n    }\n\n  } finally {\n    await worker.exit()\n  }\n\n})\n\nTest.serial('Process.createPidFile(path) on exit', async (test) => {\n\n  let path = `${test.context.basePath}/on-exit.pid`\n  let worker = new WorkerClient(Require.resolve('./worker.js'))\n\n  try {\n    await worker.module.createPidFile(path, { 'handleExit': true, 'handleKillSignal': false })\n  } finally {\n    await worker.exit()\n  }\n\n  test.false(await FileSystem.pathExists(path))\n\n})\n\nTest.serial('Process.createPidFile(path) on uncaught exception', async (test) => {\n\n  let path = `${test.context.basePath}/on-uncaught-exception.pid`\n  let worker = new LoggedClient(Require.resolve('./worker.js'))\n\n  try {\n    await worker.module.createPidFile(path, { 'handleExit': true, 'handleKillSignal': false })\n  } finally {\n    await worker.module.throwUncaughtException()\n    await new Promise((resolve) => setTimeout(resolve, 1000))\n  }\n\n  test.false(await FileSystem.pathExists(path))\n\n})\n\nTest.serial('Process.createPidFile(path) on SIGINT optionally throws ProcessOptionNotSupportedError', async (test) => {\n\n  let path = `${test.context.basePath}/on-sigint.pid`\n  let worker = new LoggedClient(Require.resolve('./worker.js'))\n\n  if (Is.windows()) {\n\n    try {\n      await test.throwsAsync(worker.module.createPidFile(path, { 'handleExit': true, 'handleKillSignal': [ 'SIGINT' ] }), { 'instanceOf': Error })\n    } finally {\n      await worker.exit()\n    }\n    \n  } else {\n\n    try {\n      await worker.module.createPidFile(path, { 'handleExit': false, 'handleKillSignal': [ 'SIGINT' ] })\n    } finally {\n      Process.killPidFile(path, 'SIGINT')\n      await new Promise((resolve) => setTimeout(resolve, 1000))\n    }\n\n  }\n\n  test.false(await FileSystem.pathExists(path))\n\n})\n\nTest.serial('Process.createPidFile(path) on SIGTERM optionally throws ProcessOptionNotSupportedError', async (test) => {\n\n  let path = `${test.context.basePath}/on-sigterm.pid`\n  let worker = new LoggedClient(Require.resolve('./worker.js'))\n\n  if (Is.windows()) {\n\n    try {\n      await test.throwsAsync(worker.module.createPidFile(path, { 'handleExit': false, 'handleKillSignal': [ 'SIGTERM' ] }), { 'instanceOf': Error })\n    } finally {\n      await worker.exit()\n    }\n    \n  } else {\n\n    try {\n      await worker.module.createPidFile(path, { 'handleExit': false, 'handleKillSignal': [ 'SIGTERM' ] })\n    } finally {\n      Process.killPidFile(path, 'SIGTERM')\n      await new Promise((resolve) => setTimeout(resolve, 1000))\n    }\n\n  }\n\n  test.false(await FileSystem.pathExists(path))\n\n})\n"],"file":"process-create-pid-file.test.js"}